{% assign emptyarray = "" | split: "," %}
{% assign data = site.data[include.data]
  | default: site[include.data]
  | default: emptyarray
  | data_filter: include.filter
%}

{%- comment -%}
연도별 그룹
{%- endcomment -%}
{% assign years = data
  | group_by_exp: "d", "d.date | date: '%Y'"
  | sort: "name" | reverse
%}

{% for year in years %}
  {% assign year_items = year.items %}

  {% if years.size > 1 %}
    {{--}}<h3 id="{{ year.name }}">{{ year.name }}</h3>
  {% endif %}

  {%- comment -%}
  같은 연도 안에서 날짜(월/일) 그룹을 최신순으로
  (YYYY-MM 또는 YYYY-MM-DD 모두 지원)
  {%- endcomment -%}
  {% assign date_groups = year_items
    | group_by_exp: "d", "d.date | date: '%Y-%m'"
    | sort: "name" | reverse
  %}

  {% for dg in date_groups %}
    {% assign items = dg.items %}

    {%- comment -%}
    같은 날짜(dg) 안에서:
      1) 제목 오름차순으로 한 번 정렬(최후 타이브레이커)
      2) 첫 저자 ㄱㄴㄷ 순으로 배치
    Liquid의 sort는 안정 정렬이 아니므로,
    '첫 저자 배열'을 만들어 그 순서대로 다시 출력한다.
    {%- endcomment -%}
    {% assign items_by_title = items | sort_natural: "title" %}

    {% assign first_authors = "" | split: "|" %}
    {% for d in items_by_title %}
      {% assign fa = d.authors | first | default: "" %}
      {% assign first_authors = first_authors | push: fa %}
    {% endfor %}
    {% assign first_authors = first_authors | uniq | sort_natural %}

    {% for fa in first_authors %}
      {% for d in items_by_title %}
        {% assign d_fa = d.authors | first | default: "" %}
        {% if d_fa == fa %}
          {% assign style = d.style | default: include.style %}
          {%
            include {{ include.component | append: ".html" }}
            affiliation=d.affiliation
            author=d.author
            authors=d.authors
            buttons=d.buttons
            caption=d.caption
            content=d.content
            date=d.date
            description=d.description
            excerpt=d.excerpt
            height=d.height
            icon=d.icon
            id=d.id
            image=d.image
            last_modified_at=d.last_modified_at
            link=d.link
            lookup=d.lookup
            name=d.name
            publisher=d.publisher
            repo=d.repo
            role=d.role
            slug=d.slug
            style=style
            subtitle=d.subtitle
            tags=d.tags
            text=d.text
            title=d.title
            tooltip=d.tooltip
            type=d.type
            url=d.url
            width=d.width
            kind=d.kind
          %}
        {% endif %}
      {% endfor %}
    {% endfor %}
  {% endfor %}
{% endfor %}
