{% if include.lookup %}
  {% assign citation = site.data.citations
    | where_exp: "citation",
      "citation.id == include.lookup or citation.title contains include.lookup"
    | first
  %}
{% else %}
  {% assign citation = include %}
{% endif %}

<div class="citation-container">
  <div class="citation">
    {% if include.style == "rich" %}
      <a
        {% if citation.link %}
          href="{{ citation.link | relative_url | uri_escape }}"
        {% endif %}
        class="citation-image"
        aria-label="{{ citation.title | default: "citation link" | regex_strip }}"
      >
        <img
          src="{{ citation.image | relative_url | uri_escape }}"
          alt="{{ citation.title | default: "citation image" | regex_strip }}"
          loading="lazy"
          {% include fallback.html %}
        >
      </a>
    {% endif %}

    <div class="citation-text">
      {% assign type = site.data.types[citation.type] %}
      {% if type and type.icon %}
        {% include icon.html icon=type.icon %}
      {% endif %}

      <a
        {% if citation.link %}
          href="{{ citation.link | relative_url | xml_escape }}"
        {% endif %}
        class="citation-title"
      >
        {{ citation.title | default: "[no title info]" }}
      </a>

      {%- comment -%} AUTHORS: 값이 있을 때만 렌더 {%- endcomment -%}
      {% if citation.authors and citation.authors != empty %}
        <div class="citation-authors"
          {% if citation.authors.size > 10 %}
            data-tooltip="{{ citation.authors | join: ", " | xml_escape }}"
          {% endif %}
          tabindex="0"
        >
          {{
            citation.authors
            | join: "," | split: ","
            | array_carve: 5
            | join: ", "
            | markdownify
            | remove: "<p>" | remove: "</p>"
          }}
        </div>
      {% endif %}

      {%- comment -%}
        DETAILS(발행처/날짜/ID):
        - 셋 모두 비어 있으면 전체 블록 렌더 X
        - 구분점(·)은 직전에 실제 값이 있었을 때만 출력
      {%- endcomment -%}
      {% assign has_publisher = citation.publisher %}
      {% assign has_date = citation.date %}
      {% assign has_id = citation.kind != "thesis" and citation.id %}

      {% if has_publisher or has_date or has_id %}
        <div class="citation-details">
          {% assign printed = false %}

          {% if has_publisher %}
            <span class="citation-publisher">
              {{ citation.publisher }}
            </span>
            {% assign printed = true %}
          {% endif %}

          {% if has_date %}
            {% if printed %}&nbsp;·&nbsp;{% endif %}
            <span class="citation-date">
              {{ citation.date | date: "%Y-%m" }}
            </span>
            {% assign printed = true %}
          {% endif %}

          {% if has_id %}
            {% if printed %}&nbsp;·&nbsp;{% endif %}
            <span class="citation-id">
              {{ citation.id }}
            </span>
          {% endif %}
        </div>
      {% endif %}

      {% if include.style == "rich" %}
        {% if citation.description %}
          <div class="citation-description">
            {{
              citation.description
              | markdownify
              | remove: "<p>"
              | remove: "</p>"
            }}
          </div>
        {% endif %}

        {% if citation.buttons and citation.buttons.size > 0 %}
          <div class="citation-buttons">
            {% for button in citation.buttons %}
              {%
                include button.html
                type=button.type
                icon=button.icon
                text=button.text
                link=button.link
                style="bare"
              %}
            {% endfor %}
          </div>
        {% endif %}

        {% if (citation.tags and citation.tags.size > 0) or citation.repo %}
          {% include tags.html tags=citation.tags repo=citation.repo %}
        {% endif %}
      {% endif %}
    </div>
  </div>
</div>
